"use strict";(()=>{var e={};e.id=605,e.ids=[605],e.modules={3524:e=>{e.exports=require("@prisma/client")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},5393:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>w,originalPathname:()=>f,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>m});var o={};t.r(o),t.d(o,{POST:()=>u});var a=t(5419),s=t(9108),n=t(9678),i=t(8070),d=t(7033),c=t(3990);async function u(e){try{let r=await e.text(),t=e.headers.get("x-dodo-signature");if(!t)return i.Z.json({error:"Missing webhook signature"},{status:400});if(!(0,c.po)(r,t,process.env.DODO_WEBHOOK_SECRET))return i.Z.json({error:"Invalid webhook signature"},{status:401});let o=JSON.parse(r);switch(o.type){case"checkout.session.completed":{let{metadata:e,customer_id:r,subscription_id:t,price_id:a}=o.data;if(!e?.userId)return console.error("Missing userId in webhook metadata"),i.Z.json({received:!0});let s={price_basic:1e3,price_pro:1e4,price_enterprise:1e5}[a]||0;if(await d._.apiUser.update({where:{clerkUserId:e.userId},data:{dodoSubscriptionId:t,credits:{increment:s}}}),s>1e3){let r=await d._.apiUser.findUnique({where:{clerkUserId:e.userId}});r?.unkeyKeyId&&console.log("Upgrading user to paid plan:",e.userId)}break}case"customer.subscription.deleted":{let{customer_id:e}=o.data,r=await d._.apiUser.findFirst({where:{dodoCustomerId:e}});r&&await d._.apiUser.update({where:{id:r.id},data:{dodoSubscriptionId:null}});break}case"invoice.payment_failed":{let{customer_id:e}=o.data;console.log("Payment failed for customer:",e);break}default:console.log("Unhandled event type:",o.type)}return i.Z.json({received:!0})}catch(e){return console.error("Error processing webhook:",e),i.Z.json({error:"Webhook processing failed"},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/dodo/route",pathname:"/api/webhooks/dodo",filename:"route",bundlePath:"app/api/webhooks/dodo/route"},resolvedPagePath:"/home/engine/project/app/api/webhooks/dodo/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:h,serverHooks:g,headerHooks:w,staticGenerationBailout:m}=l,f="/api/webhooks/dodo/route";function y(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}},7033:(e,r,t)=>{t.d(r,{_:()=>i});var o=t(3524);let a=globalThis,s=null,n=()=>new o.PrismaClient({log:["error"]}),i=new Proxy({},{get(e,r){if(!s)try{s=a.prisma??n()}catch(e){return console.warn("Failed to initialize Prisma client:",e),async()=>(console.error("Database not available"),[])}return"model"===r||"apiUser"===r||"usageLog"===r||"pricingPlan"===r?new Proxy({},{get:(e,t)=>async(...e)=>{try{return await s[r][t](...e)}catch(e){if(console.error(`Database error on ${String(r)}.${String(t)}:`,e?.message||e),"findMany"===t||"findFirst"===t)return[];if("count"===t)return 0;if("create"===t||"update"===t||"delete"===t)throw e;return null}}}):s?.[r]}})},3990:(e,r,t)=>{t.d(r,{Mc:()=>a,Pg:()=>n,po:()=>i,wK:()=>s});let o="https://api.dodopayments.com";async function a({priceId:e,customerId:r,successUrl:t,cancelUrl:a,metadata:s}){let n=await fetch(`${o}/checkout/sessions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.DODO_SECRET_KEY}`},body:JSON.stringify({price_id:e,customer_id:r,success_url:t,cancel_url:a,metadata:s})});if(!n.ok){let e=await n.json();throw Error(`Failed to create checkout session: ${e.message}`)}return n.json()}async function s({email:e,name:r}){let t=await fetch(`${o}/customers`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.DODO_SECRET_KEY}`},body:JSON.stringify({email:e,name:r})});if(!t.ok){let e=await t.json();throw Error(`Failed to create customer: ${e.message}`)}return t.json()}async function n({customerId:e,returnUrl:r}){let t=await fetch(`${o}/customers/${e}/portal_session`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.DODO_SECRET_KEY}`},body:JSON.stringify({return_url:r})});if(!t.ok){let e=await t.json();throw Error(`Failed to create portal session: ${e.message}`)}return t.json()}function i(e,r,o){return r===t(6113).createHmac("sha256",o).update(e).digest("hex")}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[638,206],()=>t(5393));module.exports=o})();